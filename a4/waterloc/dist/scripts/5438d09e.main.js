"use strict";var mmap,markers=[],ModelModule=function(){var a=function(){this.listeners=[]};_.extend(a.prototype,{addListener:function(a){this.listeners.push(a)},removeListener:function(a){var b=this.listeners.indexOf(a);-1!==b&&this.listeners.splice(b,1)},notify:function(a){}});var b=function(b,c){a.apply(this,arguments),this.build_name=b,this.build_code=c,this.checkedornot=!1};_.extend(b.prototype,a.prototype,{});var c=function(){a.apply(this,arguments),this.buildinglist=[]};_.extend(c.prototype,a.prototype,{addbuilding:function(a){this.buildinglist.push(a)},flag:function(a){for(var b=0;b<this.buildinglist.length;b++)if(this.buildinglist[b].build_name===a)if(this.buildinglist[b].checkedornot===!0){this.buildinglist[b].checkedornot=!1,document.getElementById(a).childNodes[1].checked=!1,document.getElementById(a).style.backgroundColor="white";for(var c=0;c<markers.length;c++)!function(){markers[c].name===a&&markers[c].setMap(null)}()}else this.buildinglist[b].checkedornot=!0,document.getElementById(a).childNodes[1].checked=!0,document.getElementById(a).style.backgroundColor="#6699FF",$.ajax({url:"http://maps.googleapis.com/maps/api/geocode/json?address="+a+" Waterloo&sensor=false",type:"POST",success:function(b){for(var c=new google.maps.LatLng(b.results[0].geometry.location.lat,b.results[0].geometry.location.lng),d=!1,e=0;e<markers.length;e++)!function(){markers[e].name===a&&(d=!0,markers[e].setMap(mmap))}();d===!1&&markers.push(new google.maps.Marker({position:c,map:mmap,name:a}))}})}});var d=function(){this.init=function(){var a={center:new google.maps.LatLng(43.47294,-80.542284),zoom:15};mmap=new google.maps.Map(document.getElementById("mymap"),a)}};return{BuildingModel:b,BuildingListModel:c,map:d}}(),ServiceModule=function(){var a=function(){this.key="2fc2cee3e20d957924d36373e374e0bf",this.urlPrefix="https://api.uwaterloo.ca/v2"};return _.extend(a.prototype,{queryBuildings:function(){var a=[],b=localStorage.getItem("buildlist");if(b)for(var c=JSON.parse(b),d=0;d<c.data.length;d++)a.push([c.data[d].building_name,c.data[d].building_code]);else{var e;e=new XMLHttpRequest,e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var b=e.responseText;localStorage.setItem("buildlist",b);for(var c=JSON.parse(b),d=0;d<c.data.length;d++)a.push([c.data[d].building_name,c.data[d].building_code])}},e.open("GET","https://api.uwaterloo.ca/v2/buildings/list.json?key=2fc2cee3e20d957924d36373e374e0bf",!0),e.send()}return a}}),{UWaterlooService:a}}(),ViewModule=function(a){var b=function(a){this.model=a,this.model.addListener(this)};_.extend(b.prototype,{init:function(){}});var c=function(a){b.apply(this,arguments),this.init=function(){for(var a=this,b=this.model.buildinglist,c=document.getElementById("listbody"),d=document.getElementById("checkboxtemplate"),e=0;e<b.length;e++)!function(){var f=document.createElement("div");f.innerHTML=d.innerHTML;b[e];f.childNodes[3].innerHTML=b[e].build_name+"("+b[e].build_code+")",f.id=b[e].build_name,f.addEventListener("click",function(){a.model.flag(f.id)}),c.appendChild(f)}()}};return _.extend(c.prototype,b.prototype,{}),{BuildingListView:c}}(ModelModule.BuildingModel);!function(a,b,c){$(document).ready(function(){for(var a=new c.UWaterlooService,b=a.queryBuildings(),d=ModelModule,e=new d.BuildingListModel,f=ViewModule,g=0;g<b.length;g++){var h=new d.BuildingModel(b[g][0],b[g][1]);e.addbuilding(h)}var i=new d.map;window.onload=i.init();var j=new f.BuildingListView(e);j.init();var k=document.getElementById("listbody").childNodes,l=document.getElementById("searchfield");l.addEventListener("keyup",function(){if(""===l.value)for(var a=0;a<b.length;a++)k[a].style.display="block";else for(var c=0;c<b.length;c++){var d=l.value,f=e.buildinglist[c].build_name+"("+e.buildinglist[c].build_code+")";f.toLowerCase().indexOf(d.toLowerCase())>-1?k[c].style.display="block":k[c].style.display="none"}})})}(ModelModule,ViewModule,ServiceModule);